# Functions in Fogchain Smart Contract

## `register_<node_type>`
- **Description** <br>
  register as a node, the node type can be either `consumer`, `prosumer`, `battery_station`, or `power_station`. Only nonregistered account can call this function. This function doesn't have a return value.
- **Syntax** <br>
`register_<node_type>()`

<br>

## `post_cons` 
- **Description** <br>
  Post the amount of electricity consumption since the last posting. If the function is called multiple times in a sequence block by the same poster, the consumption is accumulated. This function is nonconst, used by anyone who consumes electricity (consumer, prosumer, battery station, etc.)
- **Syntax** <br>
`post_cons(uint amount)`
- **Parameters** <br>
  - `amount`: (`uint`), the amount of electricity consumption since the last posting, in Joule.
- **Return value** <br>
  `(uint seqnum, uint cons)`: 
    - `seqnum`: the current sequence number
    - `cons`: the amount of electricity consumption of the poster in the current sequence block
- **Event emitted** <br>
    `ConsEvent(uint seqnum, address cons_addr, uint cons)`:
    - `seqnum`: indexed, the current sequence block number
    - `cons_addr`: indexed, the address of the consumer
    - `cons`: the amount of electricity consumption of the poster in the current sequence block

<br>

## `post_prod`
- **Description** <br>
  Post the amount of electricity production since the last posting. If the function is called multiple times in a sequence block by the same poster, the production is accumulated. This function is nonconstant, used by prosumers.
- **Syntax** <br>
`post_prod(uint amount)`
- **Parameters** <br>
  - `amount`: (`uint`), the amount of electricity production since the last posting, in Joule.
- **Return value** <br>
  `(uint seqnum, uint prod)`: 
    - `seqnum`: the current sequence number
    - `prod`: the amount of electricity production of the poster in the current sequence block
- **Event emitted** <br>
  `ProdEvent(uint seqnum, address prod_addr, uint prod)`:
  - `seqnum`: indexed, the current sequence block number
  - `prod_addr`: indexed, the address of the prosumer
  - `prod`: the amount of electricity production of the poster in the current sequence block

<br>

## `post_sell`
- **Description** <br>
  Post the amount of electricity sold since last posting. If the function is called multiple times in a sequence block by the same poster, the sale amount is accumulated. This function is nonconstant, used by battery stations.
- **Syntax** <br>
`post_sell(uint amount)`
- **Parameters** <br>
  - `amount`: (`uint`), the amount of electricity sold since last posting, in Joule.
- **Return value** <br>
  `(uint seqnum, uint sold)`:
    - `seqnum`: the current sequence number
    - `sold`: the amount of electricity sold by the poster in the current sequence block.
- **Event emitted** <br>
  `SellEvent(uint seqnum, address sell_addr, uint sold)`:
  - `seqnum`: indexed, the current sequence block number
  - `sell_addr`: indexed, the address of the seller (battery station)
  - `sold`: the amount of electricity sold by the poster in the current sequence block.

<br>

## `post_ps_gen`
- **Description** <br>
  *Currently this function is not used, since the electricity generation of power stations is derived from the consumption data.*
  Post the amount of electricity generated(unrenewable) by a power station since last posting. If the function is called multiple times in a sequence block by the same poster, the amount of generation is accumulated. This function is nonconstant, used by power stations.
- **Syntax** <br>
`post_ps_gen(uint amount)`
- **Parameters** <br>
  - `amount`: (`uint`), the amount of electricity generated since last posting, in Joule.
- **Return value** <br>
  `(uint seqnum, uint generation)`:
    - `seqnum`: the current sequence number
    - `generation`: the amount of electricity generated by the poster in the current sequence block.
- **Event emitted** <br>
  `PsGenEvent(uint seqnum, address sell_addr, uint generation)`:
  - `seqnum`: indexed, the current sequence block number
  - `ps_addr`: indexed, the address of the power station
  - `generation`: the amount of electricity generated by the poster in the current sequence block.

<br>

## `settle`
- **Description** <br>
  Settle the accounts for the electricity transactions happened after the last settlement. The settlement result is logged by the events emitted. This function is nonconstant, used by power station or authority agency.
- **Syntax** <br>
`settle()`
- **Return value** <br>
  `(uint seqnum)`:
    - `seqnum`: the sequence block number, `0` if the current sequence block has not ended
- **Event emitted** <br>
  `SettleEvent(uint seqnum, uint8 role, address account_addr, uint consumption, uint output,  int expense)`:
  - `seqnum`: indexed, the sequence block number
  - `role`: indexed, the role of the account
    + 1: Consumer
    + 2: Prosumer
    + 3: Battery Station
    + 4: Power Station
  - `account_addr`: indexed, the address of the node (consumer, prosumer, battery station, etc.)
  - `consumption`: the amount of the electricity consumption in the sequence block, in Joul.
  - `output`: the amount of electricity output(production, sale, etc.) into the grid, for consumer `output` is always 0.
  - `expense`: the amount of money to pay, in `wei`(`wei` is the base unit of ether). Negative value indicates expected income.
  
  `PriceEvent(uint seqnum, uint c_price, uint ps_price, uint bs_price, uint p_price)`:
  - `seqnum`: indexed, the sequence block number
  - `c_price`: the electricity consumption price, wei/Joul
  - `ps_price`: the price of power station's electricity generation, wei/Joul
  - `bs_price`: the price of battery station's electricity sale, wei/Joul
  - `p_price`: the price of prosumer's electricity production, wei/Joul
  

<br>

## `get_latest_price`
- **Syntax** <br>
`get_latest_price()`
- **Description** <br>
  Get the electricity price of the latest settled sequence block. This is a constant function, thus can be called locally.
- **Return value** <br>
  `(uint price)`: 
    - `price`: the electricity price, in `wei/Joul` (`wei` is the base unit of ether) 

<br>

## `get_bill`
- **Syntax** <br>
`get_bill(address account)`
- **Description** <br>
  Get the amount of **unpaid** income or expense. The result only accounts for the transactions happened before the last settlement (see `settle`)
- **Return value** <br>
  `(int expense)`: 
    - `expense`: the expense to pay, in `wei`. Negative value indicates expected income.



<br>

## `get_current_seqnum`
- **Syntax** <br>
`get_current_seqnum()`
- **Description** <br>
  Get the current sequence block number, based on the lastest block time and the time window of the sequence. This is a constant function, thus can be called locally.
- **Return value** <br>
  `(int seqnum)`: 
    - `seqnum`: The current sequence block number.

<br>

## `get_last_settlement`
- **Syntax** <br>
`get_last_settlement()`
- **Description** <br>
  Get the sequence block number of last settlement. This is a constant function, thus can be called locally.
- **Return value** <br>
  `(int seqnum)`: 
    - `seqnum`: The sequence block number of last settlement.

<br>


## Constructor
- **Description** <br>
  Construct the contract. The `lastest_price` would be initialized with the average of `renew_price` and `unre_price`
- **Syntax** <br>
`<contract_name>(uint seq_blk_interval, uint renew_price, uint unre_price)`
- **Parameters** <br>
  - `seq_blk_interval`: the length of each sequence block, in second.
  - `renew_price`: the price of the electricity production of prosumer, in wei/Joul.
  - `unre_price`: the price of the electricity generation of power station, in wei/Joul.